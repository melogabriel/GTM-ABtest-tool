<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GTM A/B Test Generator</title>
  <script>
    function generateJSON() {
      // Get all the values from the form
      const testName = document.getElementById("testName").value || "AB Test";
      const cookieName = document.getElementById("cookieName").value || "ab_test_group";
      const selector = document.getElementById("selector").value || "#rates";
      const ga4Param = document.getElementById("ga4Param").value || "ab_test_group";
      const measurementId = document.getElementById("measurementId").value.trim();
      const cookieDays = parseInt(document.getElementById("cookieDays").value) || 30;

      if (!/^G-[A-Z0-9]{10}$/.test(measurementId)) {
        alert("Please enter a valid GA4 Measurement ID (e.g., G-XXXXXXXXXX)");
        return;
      }

      const abScript = `(function() {
  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  }

  function setCookie(name, value, days) {
    let expires = "";
    if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/";
  }

  const name = "${cookieName}";
  let group = getCookie(name);
  if (!group) {
    group = (Math.random() < 0.5) ? "A" : "B";
    setCookie(name, group, ${cookieDays});
  }

  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({ event: "ab_group_set", ab_group: group });

  if (group === "B") {
    const el = document.querySelector("${selector}");
    if (el) el.style.display = "none";
  }
})();`;

      // Placeholder IDs and Fingerprint are required by the import schema
      const placeholderAccountId = "12345678";
      const placeholderContainerId = "123456";
      const placeholderFingerprint = "1";
      const internalTriggerId = "1";

      const containerJSON = {
        exportFormatVersion: 2,
        containerVersion: {
          // --- ADDED METADATA ---
          accountId: placeholderAccountId,
          containerId: placeholderContainerId,
          fingerprint: placeholderFingerprint,
          // --- END ---
          container: {
            // --- ADDED METADATA ---
            accountId: placeholderAccountId,
            containerId: placeholderContainerId,
            // --- END ---
            publicId: "GTM-XXXXXXX",
            name: `A/B Test - ${testName}`
          },
          tag: [
            {
              // --- ADDED METADATA ---
              accountId: placeholderAccountId,
              containerId: placeholderContainerId,
              // --- END ---
              name: `A/B Test - Script - ${testName}`,
              type: "html",
              parameter: [{ key: "html", type: "TEMPLATE", value: abScript }],
              firingTriggerId: [internalTriggerId],
              tagFiringOption: "ONCE_PER_LOAD"
            },
            {
              // --- CORRECTED GA4 TAG STRUCTURE (PART 1: CONFIG TAG) ---
              // This tag just loads the GA4 library. It does not send the page_view.
              accountId: placeholderAccountId,
              containerId: placeholderContainerId,
              name: `A/B Test - GA4 Config - ${testName}`,
              type: "gaawe",
              parameter: [
                { key: "measurement_id", type: "TEMPLATE", value: measurementId },
                { key: "send_page_view", type: "BOOLEAN", value: "false" } 
              ],
              firingTriggerId: [internalTriggerId]
            },
            {
              // --- CORRECTED GA4 TAG STRUCTURE (PART 2: EVENT TAG) ---
              // This tag sends the page_view and the user property.
              accountId: placeholderAccountId,
              containerId: placeholderContainerId,
              name: `A/B Test - GA4 Event (page_view) - ${testName}`,
              type: "gaawc", // GA4 Event Tag Type
              parameter: [
                { key: "eventName", type: "TEMPLATE", value: "page_view" },
                { key: "configTag", type: "TEMPLATE", value: `{{A/B Test - GA4 Config - ${testName}}}`},
                // User properties are correctly set here, as part of an event
                { 
                  key: "userProperties",
                  type: "LIST",
                  list: [{
                    type: "MAP",
                    map: [
                      { key: "name", "type": "TEMPLATE", value: ga4Param },
                      { key: "value", "type": "TEMPLATE", value: `{{A/B Test Group - ${testName}}}` }
                    ]
                  }]
                }
              ],
              firingTriggerId: [internalTriggerId]
            }
          ],
          trigger: [
            {
              // --- ADDED METADATA ---
              accountId: placeholderAccountId,
              containerId: placeholderContainerId,
              // --- END ---
              name: "All Pages",
              type: "PAGEVIEW",
              triggerId: internalTriggerId,
              customEventFilter: []
            }
          ],
          variable: [
            {
              // --- ADDED METADATA ---
              accountId: placeholderAccountId,
              containerId: placeholderContainerId,
              // --- END ---
              name: `A/B Test Group - ${testName}`,
              type: "kvar",
              parameter: [{ key: "name", type: "TEMPLATE", value: cookieName }]
            }
          ]
        }
      };

      const blob = new Blob([JSON.stringify(containerJSON, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `gtm-abtest-${testName.replace(/\s+/g, "-").toLowerCase()}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }
  </script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 2rem; max-width: 700px; margin: auto; background: #f9fafb; color: #333; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    label { display: block; margin-bottom: 1rem; }
    input { width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; margin-top: 0.25rem; }
    button { padding: 0.75rem 1.5rem; font-size: 1rem; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #1d4ed8; }
    .note { font-size: 0.875rem; color: #555; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>GTM A/B Test Generator</h1>
  <p>Generate a ready-to-import GTM container JSON for a simple A/B test.</p>

  <label>Test Name <input id="testName" placeholder="Rates Section Test" /></label>
  <label>Cookie Name <input id="cookieName" placeholder="ab_test_group" /></label>
  <label>Element Selector to Hide for Group B <input id="selector" placeholder="#rates" /></label>
  <label>GA4 Parameter Name (User Property) <input id="ga4Param" placeholder="ab_test_group" /></label>
  <label>GA4 Measurement ID <input id="measurementId" placeholder="G-XXXXXXXXXX" /></label>
  <label>Cookie Duration (days) <input id="cookieDays" type="number" placeholder="30" /></label>
  <button onclick="generateJSON()">Download GTM Container JSON</button>

  <p class="note">This tool generates a full GTM container (.json) that you can import via <strong>Admin â†’ Import Container</strong>. The import will add new tags, a trigger, and a variable to your workspace. Review the imported items before publishing.</p>
</body>
</html>
